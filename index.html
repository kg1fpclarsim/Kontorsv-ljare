<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sök kontor</title>
  <style>
    :root { --bg:#f9f9f9; --fg:#111; --muted:#6b7280; --brand:#1e90ff; --brand-dark:#1874cc; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif; background:var(--bg); color:var(--fg); margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .card { width:min(92vw, 560px); background:#fff; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:20px; }
    h1 { font-size:20px; margin:4px 0 16px; text-align:center; }
    .row { display:flex; gap:10px; }
    @media (max-width: 480px){ .row { flex-direction:column; } }
    input[type="text"] { flex:1; padding:14px 12px; font-size:16px; border:1px solid #e5e7eb; border-radius:12px; outline:none; }
    input[type="text"]:focus { border-color:var(--brand); box-shadow:0 0 0 3px rgba(30,144,255,.15); }
    button { padding:14px 18px; font-size:16px; border:0; border-radius:12px; background:var(--brand); color:#fff; cursor:pointer; }
    button:active { background:var(--brand-dark); }
    #result { margin-top:16px; font-size:18px; font-weight:600; text-align:center; word-wrap:break-word; }
    #debug { margin-top:10px; font-size:12px; color:var(--muted); text-align:center; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Sök kontor</h1>
    <div class="row">
      <input id="q" type="text" autocomplete="postal-code" placeholder="Postnummer eller ort" />
      <button id="go">Sök</button>
    </div>
    <div id="result"></div>
    <div id="debug"></div>
  </div>

  <script>
    // *** VIKTIGT: Ange din riktiga RAW-länk här ***
    // Exempel: https://raw.githubusercontent.com/<user>/<repo>/<branch>/Schenker%20kontor.csv
    const CSV_URL = "https://raw.githubusercontent.com/DITT_GITHUB_ANVANDARE/DITT_REPO/main/Schenker%20kontor.csv";

    // --- Hjälpfunktioner ---
    const nz = v => (v==null ? "" : String(v));
    const normHeader = h => nz(h).trim().toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9åäö]/g,'');
    const normPN = p => nz(p).replace(/\s+/g,'');
    const normTxt = t => nz(t).trim().toLowerCase();

    function bestDelimiter(text){
      const head = text.slice(0, 5000);
      const counts = { ';': (head.match(/;/g)||[]).length, ',': (head.match(/,/g)||[]).length, '\t': (head.match(/\t/g)||[]).length };
      return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
    }

    function splitCSVLine(line, delim){
      const out=[]; let cur=""; let q=false; const d = delim === "\t" ? "\t" : delim;
      for (let i=0;i<line.length;i++){
        const ch=line[i];
        if (ch==='"'){
          if (q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; }
        } else if (ch===d && !q){ out.push(cur); cur=""; } else { cur+=ch; }
      }
      out.push(cur);
      return out;
    }

    function parseCSV(text){
      text = text.replace(/^\uFEFF/, '');
      const delim = bestDelimiter(text);
      const lines = text.split(/\r?\n/).filter(l=>l.length>0);
      if (!lines.length) return { headers:[], rows:[] };
      const headers = splitCSVLine(lines[0], delim).map(h=>h.trim());
      const rows = [];
      for (let i=1;i<lines.length;i++){
        const cols = splitCSVLine(lines[i], delim);
        const obj={};
        for (let c=0;c<headers.length;c++) obj[normHeader(headers[c]||('col'+c))] = (cols[c]||"").replace(/^"|"$/g, '').trim();
        rows.push(obj);
      }
      return { headers, rows };
    }

    // --- Ladda CSV ---
    let state = { rows:[], headers:[], idx:{ postnummer:-1, postort:-1, kontor:-1 } };

    async function init(){
      const resEl = document.getElementById('result');
      const dbgEl = document.getElementById('debug');

      if (CSV_URL.includes('DITT_GITHUB_ANVANDARE') || CSV_URL.includes('DITT_REPO')){
        resEl.textContent = 'Konfigurera CSV_URL i koden med din riktiga raw-länk till "Schenker kontor.csv".';
        return;
      }

      try{
        const resp = await fetch(CSV_URL, { cache:'no-store' });
        if (!resp.ok) throw new Error(resp.status + ' ' + resp.statusText);
        const text = await resp.text();
        const { headers, rows } = parseCSV(text);
        state.headers = headers;
        state.rows = rows;

        // Mappa kolumner
        const candidates = {
          postnummer: ['Postnummer','Postnr','Post nr','Postkod','Postnummer '],
          postort: ['Postort','Ort'],
          kontor: ['Kontor','Kontorsnamn','Kontor namn','Kontoret','Kontor/Ort','Kontorfrk','Kontorsförkortning','Kontorsforkortning']
        };
        const idx = { postnummer:-1, postort:-1, kontor:-1 };
        const nh = headers.map(normHeader);
        function findIdx(list){
          for (const wanted of list){
            const k = normHeader(wanted);
            const i = nh.indexOf(k);
            if (i !== -1) return i;
          }
          return -1;
        }
        idx.postnummer = findIdx(candidates.postnummer);
        idx.postort    = findIdx(candidates.postort);
        idx.kontor     = findIdx(candidates.kontor);
        state.idx = idx;

        // Debugvisning
        dbgEl.textContent = `Kolumner: ${headers.join(' | ')}  |  index: pn=${idx.postnummer}, ort=${idx.postort}, kontor=${idx.kontor}  |  rader: ${rows.length}`;

        if (rows.length === 0){ resEl.textContent = 'CSV laddad men 0 rader hittades.'; }
        else if (idx.postnummer === -1 || idx.postort === -1 || idx.kontor === -1){
          resEl.textContent = 'Kunde inte hitta nödvändiga kolumner (Postnummer, Postort, Kontor). Kontrollera headerrad i CSV.';
        } else {
          resEl.textContent = '';
        }
      } catch(err){
        document.getElementById('result').textContent = 'Fel vid hämtning av CSV: ' + err.message + '. Om sidan öppnas som en lokal fil kan webbläsaren blockera hämtning – prova att hosta sidan (t.ex. GitHub Pages).';
      }
    }

    // --- Söklogik (Excel: Postnummer -> Kontor, annars Postort -> Kontor; med snäll fallback på delsträng för ort) ---
    function lookup(q){
      const { rows, idx, headers } = state;
      if (!rows.length) return { text:'Ingen data laddad', found:false };
      if (idx.postnummer === -1 || idx.postort === -1 || idx.kontor === -1) return { text:'Saknar nödvändiga kolumner', found:false };

      const pnKey = normPN(q);
      const pnHdr = normHeader(headers[idx.postnummer]);
      const koHdr = normHeader(headers[idx.kontor]);
      for (const r of rows){
        if (normPN(r[pnHdr]) === pnKey && pnKey){
          return { text: r[koHdr] || '—', found:true };
        }
      }

      const ortKey = normTxt(q);
      const ortHdr = normHeader(headers[idx.postort]);
      // exakt ort
      for (const r of rows){
        if (normTxt(r[ortHdr]) === ortKey && ortKey){
          return { text: r[koHdr] || '—', found:true };
        }
      }
      // snäll fallback: delsträng (minst 2 tecken)
      if (ortKey.length >= 2){
        for (const r of rows){
          if (normTxt(r[ortHdr]).includes(ortKey)){
            return { text: r[koHdr] || '—', found:true };
          }
        }
      }
      return { text:'Ingen träff', found:false };
    }

    // --- UI ---
    const input = document.getElementById('q');
    const btn = document.getElementById('go');
    const result = document.getElementById('result');

    btn.addEventListener('click', () => {
      const q = input.value.trim();
      if (!q){ result.textContent = 'Ange postnummer eller ort'; return; }
      const { text } = lookup(q);
      result.textContent = text;
    });
    input.addEventListener('keydown', e => { if (e.key === 'Enter') btn.click(); });

    init();
  </script>
</body>
</html>
