<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sök kontor</title>
  <style>
    body {font-family: Arial, Helvetica, sans-serif; background:#f9f9f9; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; margin:0;}
    h2 {margin-bottom:20px;}
    #searchBox {width: 300px; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:8px;}
    #searchBtn {padding:10px 20px; margin-left:10px; font-size:16px; border:none; border-radius:8px; background:#0073e6; color:white; cursor:pointer;}
    #searchBtn:hover {background:#005bb5;}
    #result {margin-top:20px; font-size:18px; font-weight:bold;}
  </style>
</head>
<body>
  <h2>Sök kontor</h2>
  <div>
    <input id="searchBox" placeholder="Ange postnummer eller ort">
    <button id="searchBtn">Sök</button>
  </div>
  <div id="result"></div>

  <script>
    const csvUrl = "Shenker kontor.csv"; // <-- ändra till rätt raw-länk
    let table = [];
    let rawHeaders = [];
    let indices = {};

    function detectDelimiter(text){
      if (text.indexOf(';') !== -1) return ';';
      if (text.indexOf(',') !== -1) return ',';
      if (text.indexOf('\t') !== -1) return '\t';
      return ',';
    }

    function splitCSVLine(line, delimiter){
      const out = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++){
        const ch = line[i];
        if (ch === '"'){
          if (inQuotes && line[i+1] === '"') { cur += '"'; i++; continue; }
          inQuotes = !inQuotes;
          continue;
        }
        if (ch === delimiter && !inQuotes){
          out.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(s => s === undefined ? '' : s);
    }

    function normalizeHeader(h){
      if (!h) return '';
      return h.toString().trim().toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9åäö]/g,'');
    }

    function findHeaderIndex(headers, candidates){
      for (let i = 0; i < headers.length; i++){
        const nh = normalizeHeader(headers[i]);
        for (const c of candidates){
          if (nh === normalizeHeader(c)) return i;
        }
      }
      return -1;
    }

    function normalizePostnummer(p){ return (p||'').toString().replace(/\s+/g,''); }
    function normalizeText(t){ return (t||'').toString().trim().toLowerCase(); }

    function parseAndIndexCSV(text){
      text = text.replace(/^\uFEFF/, '');
      const delimiter = detectDelimiter(text);
      const lines = text.split(/\r?\n/);
      let headerLineIndex = 0;
      while (headerLineIndex < lines.length && lines[headerLineIndex].trim() === '') headerLineIndex++;
      const headers = splitCSVLine(lines[headerLineIndex], delimiter).map(h => h.trim());
      rawHeaders = headers.slice();

      indices.postnummer = findHeaderIndex(headers, ['Postnummer','Postnr']);
      indices.postort = findHeaderIndex(headers, ['Postort','Ort']);
      indices.kontor = findHeaderIndex(headers, ['Kontor']);

      table = [];
      for (let i = headerLineIndex + 1; i < lines.length; i++){
        if (lines[i].trim() === '') continue;
        const cols = splitCSVLine(lines[i], delimiter);
        const obj = {};
        for (let c = 0; c < headers.length; c++){
          obj[normalizeHeader(headers[c] || ('col'+c))] = (cols[c] || '').trim();
        }
        table.push(obj);
      }
    }

    function searchKontor(input){
      if (!input) return null;
      const postnummerHdr = normalizeHeader(rawHeaders[indices.postnummer]);
      const postortHdr = normalizeHeader(rawHeaders[indices.postort]);
      const kontorHdr = normalizeHeader(rawHeaders[indices.kontor]);

      const pn = normalizePostnummer(input);
      for (let r of table){
        if (normalizePostnummer(r[postnummerHdr]) === pn){
          return r[kontorHdr];
        }
      }

      const ort = normalizeText(input);
      for (let r of table){
        if (normalizeText(r[postortHdr]) === ort){
          return r[kontorHdr];
        }
      }
      return null;
    }

    fetch(csvUrl).then(r => r.text()).then(text => {
      parseAndIndexCSV(text);
      document.getElementById('searchBtn').disabled = false;
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      const val = document.getElementById('searchBox').value;
      const res = searchKontor(val);
      document.getElementById('result').textContent = res ? res : "Ingen träff";
    });

    document.getElementById('searchBox').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('searchBtn').click();
    });
  </script>
</body>
</html>
